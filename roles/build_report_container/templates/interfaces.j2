<!-- INTERNAL TABLE FOR INTERFACES -->
<div id="accordion">
<div>
<h3>Interfaces - Admin Status/Operational Status/MTU/Duplex/Speed</h3>
<div class="net_content">
{% if hostvars[network_switch]['ansible_network_resources']['interfaces'] is defined and hostvars[network_switch]['ansible_network_resources']['interfaces']|length > 0  %}
<table id="subtable">
    <thead>
        <tr>
            <th>Interface Name</th>
            <th>Description</th>
            <th>Admin Status</th>
            <th>Operational Status</th>
            <th>Protocol Status</th>
            <th>IP Address</th>
            <th>Duplex</th>
            <th>MTU</th>
            <th>Speed</th>
        </tr>
    </thead>
    <tbody>
{% for interface in hostvars[network_switch]['ansible_network_resources']['interfaces'] %}
        <tr>
            <td>{{interface['name']}}</td>
            <td>{{interface['description']|default("none")}}</td>
            <td>
                {% if interface['enabled'] %}
                <span style="color: green; font-weight: bold;">UP</span>
                {% else %}
                <span style="color: red; font-weight: bold;">DOWN</span>
                {% endif %}
            </td>
            <!-- Find operational status for this interface -->
            {% set oper_found = false %}
            {% if hostvars[network_switch]['operational_status_data'] is defined %}
                {% for status in hostvars[network_switch]['operational_status_data'] %}
                    {# Normalize interface names for comparison #}
                    {% set status_interface = status[0]|lower|replace(' ', '') %}
                    {% set current_interface = interface['name']|lower|replace(' ', '') %}
                    {% if status_interface == current_interface %}
                        <td>
                            {% if status[2]|lower == 'up' %}
                            <span style="color: green; font-weight: bold;">{{ status[2]|upper }}</span>
                            {% elif status[2]|lower == 'down' %}
                            <span style="color: red; font-weight: bold;">{{ status[2]|upper }}</span>
                            {% elif 'admin' in status[2]|lower %}
                            <span style="color: orange; font-weight: bold;">ADMIN DOWN</span>
                            {% else %}
                            <span style="color: orange; font-weight: bold;">{{ status[2]|upper }}</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if status[3]|lower == 'up' %}
                            <span style="color: green; font-weight: bold;">{{ status[3]|upper }}</span>
                            {% elif status[3]|lower == 'down' %}
                            <span style="color: red; font-weight: bold;">{{ status[3]|upper }}</span>
                            {% else %}
                            <span style="color: orange; font-weight: bold;">{{ status[3]|upper }}</span>
                            {% endif %}
                        </td>
                        <td>{{ status[1] if status[1] != 'unassigned' else 'N/A' }}</td>
                        {% set oper_found = true %}
                    {% endif %}
                {% endfor %}
            {% endif %}
            {% if not oper_found %}
                <!-- Try to get status from ansible_net_interfaces if available -->
                {% if hostvars[network_switch]['interface_status'] is defined and 
                      hostvars[network_switch]['interface_status'][interface['name']] is defined %}
                    {% set iface_data = hostvars[network_switch]['interface_status'][interface['name']] %}
                    <td>
                        {% if iface_data['operstatus'] is defined %}
                            {% if iface_data['operstatus']|lower == 'up' %}
                            <span style="color: green; font-weight: bold;">UP</span>
                            {% else %}
                            <span style="color: red; font-weight: bold;">{{ iface_data['operstatus']|upper }}</span>
                            {% endif %}
                        {% else %}
                            <span style="color: gray;">N/A</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if iface_data['lineprotocol'] is defined %}
                            {% if iface_data['lineprotocol']|lower == 'up' %}
                            <span style="color: green; font-weight: bold;">UP</span>
                            {% else %}
                            <span style="color: red; font-weight: bold;">{{ iface_data['lineprotocol']|upper }}</span>
                            {% endif %}
                        {% else %}
                            <span style="color: gray;">N/A</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if iface_data['ipv4'] is defined and iface_data['ipv4']|length > 0 %}
                            {{ iface_data['ipv4'][0]['address'] }}/{{ iface_data['ipv4'][0]['subnet'] }}
                        {% else %}
                            N/A
                        {% endif %}
                    </td>
                {% else %}
                    <td><span style="color: gray;">N/A</span></td>
                    <td><span style="color: gray;">N/A</span></td>
                    <td><span style="color: gray;">N/A</span></td>
                {% endif %}
            {% endif %}
            <td>{{interface['duplex']|default("default")}}</td>
            <td>{{interface['mtu']|default("default")}}</td>
            <td>{{interface['speed']|default("default")}}</td>
        </tr>
{% endfor %}
    </tbody>
</table>

<!-- Interface Status Summary -->
{% set total_interfaces = hostvars[network_switch]['ansible_network_resources']['interfaces'] | length %}
{% set admin_up = hostvars[network_switch]['ansible_network_resources']['interfaces'] | selectattr('enabled', 'equalto', true) | list | length %}
{% set admin_down = total_interfaces - admin_up %}

<!-- Calculate operational status counts -->
{% set ns = namespace(oper_up=0, oper_down=0, proto_up=0, proto_down=0) %}
{% if hostvars[network_switch]['operational_status_data'] is defined %}
    {% for status in hostvars[network_switch]['operational_status_data'] %}
        {% if status[2]|lower == 'up' %}
            {% set ns.oper_up = ns.oper_up + 1 %}
        {% else %}
            {% set ns.oper_down = ns.oper_down + 1 %}
        {% endif %}
        {% if status[3]|lower == 'up' %}
            {% set ns.proto_up = ns.proto_up + 1 %}
        {% else %}
            {% set ns.proto_down = ns.proto_down + 1 %}
        {% endif %}
    {% endfor %}
{% elif hostvars[network_switch]['interface_status'] is defined %}
    {% for iface_name, iface_data in hostvars[network_switch]['interface_status'].items() %}
        {% if iface_data['operstatus'] is defined %}
            {% if iface_data['operstatus']|lower == 'up' %}
                {% set ns.oper_up = ns.oper_up + 1 %}
            {% else %}
                {% set ns.oper_down = ns.oper_down + 1 %}
            {% endif %}
        {% endif %}
        {% if iface_data['lineprotocol'] is defined %}
            {% if iface_data['lineprotocol']|lower == 'up' %}
                {% set ns.proto_up = ns.proto_up + 1 %}
            {% else %}
                {% set ns.proto_down = ns.proto_down + 1 %}
            {% endif %}
        {% endif %}
    {% endfor %}
{% endif %}

<div style="margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 4px;">
    <strong>Interface Summary:</strong>
    Total: {{ total_interfaces }} | 
    Admin UP: <span style="color: green;">{{ admin_up }}</span> | 
    Admin DOWN: <span style="color: red;">{{ admin_down }}</span>
    {% if ns.oper_up > 0 or ns.oper_down > 0 %}
    | Operationally UP: <span style="color: green;">{{ ns.oper_up }}</span> | 
    Operationally DOWN: <span style="color: red;">{{ ns.oper_down }}</span>
    {% endif %}
    {% if ns.proto_up > 0 or ns.proto_down > 0 %}
    | Protocol UP: <span style="color: green;">{{ ns.proto_up }}</span> | 
    Protocol DOWN: <span style="color: red;">{{ ns.proto_down }}</span>
    {% endif %}
</div>

{% elif hostvars[network_switch]['ansible_network_resources']['interfaces'] is defined and hostvars[network_switch]['ansible_network_resources']['interfaces']|length == 0 %}
No interfaces configured on this device
{% else %}
No Interface information available
{% endif %}
</div>
</div>
</div>
<!-- END INTERNAL TABLE FOR INTERFACES -->
